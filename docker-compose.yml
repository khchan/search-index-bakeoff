version: '3.8'

services:
  search-index-writer:
    build:
      context: .
      dockerfile: writer/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - AZURE_OPENAI_EMBEDDING_ENDPOINT=${AZURE_OPENAI_EMBEDDING_ENDPOINT}
      - AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME=${AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME}
      - AZURE_OPENAI_EMBEDDING_API_VERSION=${AZURE_OPENAI_EMBEDDING_API_VERSION:-2024-02-01}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - VENA_ENDPOINT=${VENA_ENDPOINT}
      - VENA_USER=${VENA_USER}
      - VENA_KEY=${VENA_KEY}
      - LANCEDB_BASE_PATH=/app/data/lancedb
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - lancedb_data:/app/data/lancedb
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  search-index-reader:
    build:
      context: .
      dockerfile: reader/Dockerfile
    ports:
      - "8002:8002"
    environment:
      - AZURE_OPENAI_EMBEDDING_ENDPOINT=${AZURE_OPENAI_EMBEDDING_ENDPOINT}
      - AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME=${AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME}
      - AZURE_OPENAI_EMBEDDING_API_VERSION=${AZURE_OPENAI_EMBEDDING_API_VERSION:-2024-02-01}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - LANCEDB_BASE_PATH=/app/data/lancedb
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - lancedb_data:/app/data/lancedb
    depends_on:
      - search-index-writer
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '4.0'
        reservations:
          memory: 512M
          cpus: '2.0'

volumes:
  lancedb_data:
    driver: local

networks:
  default:
    name: search-index-network